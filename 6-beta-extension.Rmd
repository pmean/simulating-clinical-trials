---
title: "Simulating clinical trials--beta extension"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r delay-preliminaries, echo=FALSE, message=FALSE}
source("0-preliminaries.R", echo=FALSE)
n_reps <- 1000
pctl_list <- c(1, 25, 50, 75, 99)
N <- 350
T <- 1095
S  <- 0.5
S1 <- 0.2
S2 <- 0.1
S3 <- 0.2
D1 <- 0.12
D2 <- 0.4
D3 <- 0.06
t1 <- 150
dat_prior <- list(
  N=N, T=T, S=S, 
  D1=D1, S1=S1,
  D2=D2, S2=S2,
  D3=D3, S3=S3,
  t=0, n=0)

dat_update1 <- dat_prior
dat_update1$t <- 150
dat_update1$n <- rep(0, 150)

pts <- unlist(read.csv("2-paths-count.csv"))
n2 <- sum(pts)
t2 <- 192 + length(pts)
dat_update2 <- dat_update1
dat_update2$t <- 192 + length(pts)
dat_update2$n <- c(rep(0, 192), pts)

save(N, T, S, S1, S2, S3, D1, D2, D3, t1, t2, n2, file="fig/6.0.RData")

N_label0 <- "Estimated total sample size (prior)"
N_label1 <- sub("prior", "update 1", N_label0)
N_label2 <- sub("prior", "update 2", N_label0)

d1_label0 <- "Days before start (prior)"
d1_label1 <- sub("prior", "update 1", d1_label0)
d1_label2 <- sub("prior", "update 2", d1_label0)

d2_label0 <- "Monthly accrual rate during warm-up phase (prior)"
d2_label1 <- sub("prior", "update 1", d2_label0)
d2_label2 <- sub("prior", "update 2", d2_label0)

d3_label0 <- "Days during warm-up phase (prior)"
d3_label1 <- sub("prior", "update 1", d3_label0)
d3_label2 <- sub("prior", "update 2", d3_label0)

l_label0 <- "Monthly accrual rate during late phase (prior)"
l_label1 <- sub("prior", "update 1", l_label0)
l_label2 <- sub("prior", "update 2", l_label0)
```

### Part 6. Simulating delays in a clinical trial.

There are several different models for accrual delays. They may or may not include a start-up time before ANY accrual, and they may or may not include a warm-up time early in the trial when accrual is slower. If there is a warm-up time, there are several ways to model the transition from slow accrual to full accrual.

```{r setup-graphical-framework}
data.frame(x=c(100, 200), y=c(100, 250))             %>%
  ggplot(aes(x, y))                                   +
  geom_point(color="white")                           +
  labs(x=NULL, y=NULL)                                +
  geom_segment(x   =100, y   =150, 
               xend=120, yend=150,
               color="red", size=3)                   +
  geom_segment(x   =100, y   =150, 
               xend=120, yend=150,
               color="gray", size=1)                  +
  geom_label  (x=110, y=125, fill="red", 
               label="Waiting\nto start")             +
  geom_label  (x=135, y=125, fill="yellow",
               label="Early\naccrual")                 +
  geom_segment(x   =150, y   =200,
               xend=200, yend=200,
               color="green", size=3,
               arrow=arrow(length=unit(0.1, "inch"))) +
  geom_segment(x   =150, y   =200,
               xend=200, yend=200,
               color="gray", size=1, alpha=0.5,
               arrow=arrow(length=unit(0.1, "inch"))) +
  geom_label  (x=160, y=125, fill="green",
               label="Late\naccrual")                 + 
  theme(plot.margin=unit(c(0,0,0,0),"in"))            +
  theme(axis.line =element_blank())                   +
  theme(axis.text =element_blank())                   +
  theme(axis.ticks=element_blank())                   +
  theme(axis.title=element_blank())                  -> delay_graph
```

```{r delay-example1-prelims}
delay_graph                                      +
  geom_segment(x   =120, y   =180,
               xend=150, yend=180,
               color="yellow", size=3)           +
  geom_segment(x   =120, y   =180,
               xend=150, yend=180,
               color="gray", size=1)            -> fig
save(fig, file="fig/6.1.RData")
```


### Figure 6.1. Discontinuous transition from slow to normal accrual.
 
```{r delay-example1, fig.height=2, fig.width=5}
load("fig/6.1.RData"); print(fig)
```

Here's a discontinuous transition from slow to full accrual. It has three parameters, the duration of the waiting to start period, the rate during slow accrual, and the duration of the transition to full accrual.

```{r delay-example2-prelims}
delay_graph                                      +
  geom_segment(x   =120, y   =150,
               xend=150, yend=200,
               color="yellow", size=3)           +
  geom_segment(x   =120, y   =150,
               xend=150, yend=200,
               color="gray", size=1)            -> fig
save(fig, file="fig/6.2.RData")
```

### Figure 6.2. Linear transition from slow to normal accrual.

```{r delay-example2, fig.height=2, fig.width=5}
load("fig/6.2.RData"); print(fig)
```

Here's a linear transition from slow to full accrual. It has two parameters, the duration of the waiting to start period and the duration of the transition to full accrual.

```{r delay-example3-prelims}
delay_graph                                      +
  geom_segment(x   =120, y   =250,
               xend=150, yend=200,
               color="yellow", size=3)           +
    geom_segment(x   =120, y   =250,
               xend=150, yend=200,
               color="gray", size=1)            -> fig
save(fig, file="fig/6.3.RData")
```

### Figure 6.3. Linear transition from fast to normal accrual.

```{r delay-example3, fig.height=2, fig.width=5}
load("fig/6.3.RData"); print(fig)
```

Here's an example of a partially discontinuous transition where the early accrual is fast, perhaps because there were a large number of patients waiting for the trial to start.

```{r delay-example4-prelims}
x_original <- seq(0, 1, length=50)
y_original <- 3*x_original^2-2*x_original^3
x_rescaled <- 120 + 30 * x_original
y_rescaled <- 150 + 50 * y_original
df2 <- data.frame(x=x_rescaled, y=y_rescaled)
delay_graph                                      +
  geom_path(aes(x, y), data=df2,
            color="yellow", size=3)              +
  geom_path(aes(x, y), data=df2,
            color="gray",  size=1)              -> fig
save(fig, file="fig/6.4.RData")
```

### Figure 6.4. Smooth transition from slow to normal accrual.

```{r delay-example4, fig.height=2, fig.width=5}
load("fig/6.4.RData"); print(fig)
```

Here's a smooth transition using a rescaled version of the function $f(x)=3x^2-2x^3$. This functiton is a cubic spline with the properties

f(0)=0 (starts at zero to maintain continuity at 0)

f'(0) (starts out flat to maintain smoothness at 0)

f(1)=1 (rises to a new level)

f'(1)=0 (levels off at the new level to maintain smoothness)

### Priors for a delay model

We'll fit the discontinuous model, the first one shown, because it is convenient, but there are probably very few practical differences among these models. The discontinuous model has three parameters. Delta1 represents the duration of time waiting for the trial to start as a fraction of the total time planned. Delta2 represents the ratio of the accrual rate during the slow accrual period and the accrual rate during the full accrual period. Delta3 represents the duration of time for the slow accrual period as a fraction of the total time planned.

Generally, you should use strong priors here to limit delta1 and delta3 to the lower end of the range from 0 to 1. If you really thought that delta1 and/or delta3 would be much closer to 1, then you should rethink what your total time planned should be.

```{r delay-priors1-prelims}
d1_label0a <- sub("prior", paste("prior, S1", S1/2, sep="="), d1_label0)
d1_label0b <- sub("prior", paste("prior, S1", S1,   sep="="), d1_label0)
d1_label0c <- sub("prior", paste("prior, S1", S1*2, sep="="), d1_label0)

sim1 <- data.frame(x=" ", y=rbeta(n_reps, S1/2*N*D1, S1/2*N*(1-D1))*T)
sim2 <- data.frame(x=" ", y=rbeta(n_reps, S1  *N*D1, S1  *N*(1-D1))*T)
sim3 <- data.frame(x=" ", y=rbeta(n_reps, S1*2*N*D1, S1*2*N*(1-D1))*T)

y_range <- range(sim1$y, sim2$y, sim3$y)

custom_boxplot(sim1, d1_label0a, 0, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.5a.RData")
custom_boxplot(sim2, d1_label0b, 0, "red")   + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.5b.RData")
custom_boxplot(sim3, d1_label0c, 0, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.5c.RData")
```

### Figure 6.5. Prior distribution for delta1 (time waiting to start).

```{r delay-priors1, fig.height=1, fig.width=10}
load("fig/6.5a.RData"); print(fig)
load("fig/6.5b.RData"); print(fig)
load("fig/6.5c.RData"); print(fig)
```

Here's some possible prior distributions. For delta1, the proportion of the total planned time that you spend waiting for the study to get started, a beta(`r N*D1*S1`, `r N*S1*(1-D1)`) corresponds to an expectation that `r D1*100`% of the time (`r D1*T` days) will be lost on average before the trial even begins. The total weight assigned to this prior corresponds to `r S1*100`% of the total sample size.

```{r delay-priors2-prelims}
d2_label0a <- sub("prior", paste("prior, S2", S2/2, sep="="), d2_label0)
d2_label0b <- sub("prior", paste("prior, S2", S2,   sep="="), d2_label0)
d2_label0c <- sub("prior", paste("prior, S2", S2*2, sep="="), d2_label0)

sim1 <- data.frame(x=" ", y=rbeta(n_reps, S2/2*N*D2, S2/2*N*(1-D2))*30*N/T)
sim2 <- data.frame(x=" ", y=rbeta(n_reps, S2  *N*D2, S2  *N*(1-D2))*30*N/T)
sim3 <- data.frame(x=" ", y=rbeta(n_reps, S2*2*N*D2, S2*2*N*(1-D2))*30*N/T)

y_range <- range(sim1$y, sim2$y, sim3$y)

custom_boxplot(sim1, d2_label0a, 1, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.6a.RData")
custom_boxplot(sim2, d2_label0b, 1, "red")   + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.6b.RData")
custom_boxplot(sim3, d2_label0c, 1, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.6c.RData")
```

### Figure 6.6. Prior distribution for delta2 (accrual rate early), rescaled to patients per month.

```{r delay-priors2, fig.height=1, fig.width=10}
load("fig/6.6a.RData"); print(fig)
load("fig/6.6b.RData"); print(fig)
load("fig/6.6c.RData"); print(fig)
```

For delta2, the proportionate reduction in accrual during the warm-up period, a beta(`r S2*N*D2`, `r S2*N*(1-D2)` corresponds to an expectation that the reductiton during warm-up will be about `r 100*D2`% of the regular accrual rate on average, or roughly `r round(D2*30*N/T)` patients per month. The total weight assigned to this prior corresponds to `r S2*100`% of the total sample size.

```{r delay-priors3-prelims}
d3_label0a <- sub("prior", paste("prior, S3", S3/2, sep="="), d3_label0)
d3_label0b <- sub("prior", paste("prior, S3", S3,   sep="="), d3_label0)
d3_label0c <- sub("prior", paste("prior, S3", S3*2, sep="="), d3_label0)

sim1 <- data.frame(x=" ", y=rbeta(n_reps, S3/2*N*D3, S3/2*N*(1-D3))*T)
sim2 <- data.frame(x=" ", y=rbeta(n_reps, S3  *N*D3, S3  *N*(1-D3))*T)
sim3 <- data.frame(x=" ", y=rbeta(n_reps, S3*2*N*D3, S3*2*N*(1-D3))*T)

y_range <- range(sim1$y, sim2$y, sim3$y)

custom_boxplot(sim1, d3_label0a, 0, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.7a.RData")
custom_boxplot(sim2, d3_label0b, 0, "red")   + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.7b.RData")
custom_boxplot(sim3, d3_label0c, 0, "black") + expand_limits(y=y_range) -> fig
save(fig, file="fig/6.7c.RData")
```

### Figure 6.7. Prior distribution for delta3 (duration of early accrual), rescaled to days.

```{r delay-priors3, fig.height=1, fig.width=10}
load("fig/6.7a.RData"); print(fig)
load("fig/6.7b.RData"); print(fig)
load("fig/6.7c.RData"); print(fig)
```

For delta3, the proportion of the total planned time that you spend in the warm-up period, a beta(`r S3*N*D3`, `r S3*N*(1-D3)`) corresponds to an expectation that `r 100*D3`% of the time your trial will be stuck in the warm-up phase. The total weight assigned to this prior corresponds to `r S3*100`% of the total sample size.

### Here's the code to fit a simulation involving delays.

```{r delay_code}
f <- "6-beta-test3.jags"
cat(readLines(f), sep="\n")
```

The delay model involves discontinuities, which cause problems for stan, so this code is for a similar program called jags.

```{r delay-fit0-prelims}
mod_dm0 <- jags.model(f, data=dat_prior, 
  n.adapt = 100)

parms <- c("delta1", "delta2", "delta3", "lambda", "Nstar")
fit_dm0 <- coda.samples(mod_dm0, var=parms, n.iter = 1000)
summary(fit_dm0)
fit_dm0                                         %>%
  as.matrix                                     %>%
  as.data.frame                                 -> sim_dm0
sim_dm0                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label0, 0)                   -> fig
save(fig, file="fig/6.8.RData")
prior_estimate <- fig
```

### Figure 6.8. Prior estimate of total sample size, accounting for delays.

```{r delay-fit0, fig.height=1, fig.width=10}
load("fig/6.8.RData"); print(fig)
```

You are taking a big hit here. But you should be thankful that you're accounting for these sorts of things before the trial starts.

You should consider exploring how sensitive your estimated total sample size is relative to each of the delay parameters.

```{r delay-scaterplots-prelims}
sim_dm0                                         %>%
  mutate(x=delta1*T)                            %>%
  mutate(y=Nstar)                               %>%
  custom_scatterplot(d1_label0, N_label0, round_x=0) -> fig
save(fig, file="fig/6.9a.RData")
sim_dm0                                         %>%
  mutate(x=30*delta2*N/T)                       %>%
  mutate(y=Nstar)                               %>%
  custom_scatterplot(d2_label0, N_label0)       -> fig
save(fig, file="fig/6.9b.RData")
sim_dm0                                         %>%
  mutate(x=delta3*T)                            %>%
  mutate(y=Nstar)                               %>%
  custom_scatterplot(d3_label0, N_label0, round_x=0) -> fig
save(fig, file="fig/6.9c.RData")
sim_dm0                                         %>%
  mutate(x=lambda*30)                           %>%
  mutate(y=Nstar)                               %>%
  custom_scatterplot(l_label0, N_label0, round_x=0) -> fig
save(fig, file="fig/6.9d.RData")
```

### Figure 6.9. Effect of prior parameters on estimated total sample size.

```{r delay-scaterplots, fig.width=4, fig.height=4}
load("fig/6.9a.RData"); print(fig)
load("fig/6.9b.RData"); print(fig)
load("fig/6.9c.RData"); print(fig)
load("fig/6.9d.RData"); print(fig)
```

It looks like the proportion of time waiting to start has a far greater influence on the total sample size than the other parameters. This would change if you changed your prior distributions, of course, but in general it makes sense. Time lost waiting for the trial to start is time when no subjects enter. Time during slow accrual is important but at least you are getting some subjects in during this time frame. The relative slowness during the warm-up period is also not too critical.

The actual trial that I have used so far did not have a formal model for delays, but it is easy enough to modify the data to fit this example. You need to prepend the data with a string of zeros corresponding to the days when the trial was waiting to get started.

### Updating the delay simulation--150 days of nothing.

Suppose that you are on day `r dat_update1$t`, and not a single patient has shown up. You were expecting the time to the first patient to be around day `r round(D1*T)`, but it looks like things might be far worse. What does above average delay to the start of your study do to your estimate of the total sample size?

```{r delay-fit1-prelims-1}
mod_dm1 <- jags.model(f, data=dat_update1, 
  n.adapt = 100)

parms <- c("delta1", "delta2", "delta3", "lambda", "Nstar")
fit_dm1 <- coda.samples(mod_dm1, var=parms, n.iter = 1000)
```

```{r delay-fit1-prelims-2}
y_label <- "Estimated total sample size (update 1)"
f <- "6-beta-test3.jags"

fit_dm1                                         %>%
  as.matrix                                     %>%
  as.data.frame                                 -> sim_dm1
sim_dm1                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label1, 0, co="red")         -> update1
sim_dm0                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label0, 0, co="black")       -> prior_estimate
r <- range(sim_dm0$Nstar, sim_dm1$Nstar)
prior_estimate + expand_limits(y=r)             -> fig
save(fig, file="fig/6.10a.Rmd")
update1 + expand_limits(y=r)                    -> fig
save(fig, file="fig/6.10b.Rmd")
```


### Figure 6.10. Updated estimate of total sample size after 150 days of nothing.

```{r delay-fit1, fig.height=1, fig.width=10}
load("fig/6.10a.Rmd"); print(fig)
load("fig/6.10b.Rmd"); print(fig)
```

It looks like the delay has not hurt the trial that much so far.

```{r delay-updated_start-prelims}
sim_dm0                                         %>%
  mutate(y=delta1*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d1_label0, 0, co="black")      -> delta10
sim_dm1                                         %>%
  mutate(y=delta1*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d1_label1, 0, co="red")        -> delta11
r <- T*range(sim_dm0$delta1, sim_dm1$delta1)
delta10 + expand_limits(y=r)                    -> fig
save(fig, file="fig/6.11a.RData")
delta11 + expand_limits(y=r)                    -> fig
save(fig, file="fig/6.11b.RData")
```

### Figure 6.11. How much longer do you expect to wait after 150 days of nothing.

```{r delay-updated_start, fig.width=10, fig.height=1}
load("fig/6.11a.RData"); print(fig)
load("fig/6.11b.RData"); print(fig)
```

This boxplot shows when you think the trial will start, now that you know that the delay is at least 150 days.

The remaining parameters remain unchanged, of course.

```{r delay-update-delta2-prelims}
sim_dm0                                         %>%
  mutate(y=delta2*30*N/T)                       %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d2_label0, 1, co="black")       -> delta20
sim_dm1                                         %>%
  mutate(y=delta2*30*N/T)                       %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d2_label1, 1) -> delta21
r <- range(sim_dm0$delta2, sim_dm1$delta2)*30*N/T
delta20 + expand_limits(y=r)                    -> fig
save(fig, file="fig/6.12a.RData")
delta21 + expand_limits(y=r)                    -> fig
save(fig, file="fig/6.12b.RData")
```

### Figure 6.12. Update of delta2 after 150 days of nothing.

```{r delay-update-delta2, fig.width=10, fig.height=1}
load("fig/6.12a.RData"); print(fig)
load("fig/6.12b.RData"); print(fig)
```

```{r delay-update-delta3-prelims}
sim_dm0                                         %>%
  mutate(y=delta3*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d3_label0, 0, co="black")       -> delta30
sim_dm1                                         %>%
  mutate(y=delta3*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d3_label1, 0)                  -> delta31
r <- T*range(sim_dm0$delta3, sim_dm1$delta3)
delta30 + expand_limits(y=r) -> fig
save(fig, file="fig/6.13a.RData")
delta31 + expand_limits(y=r) -> fig
save(fig, file="fig/6.13b.RData")
```

### Figure 6.13. Update of delta3 after 150 days of nothing.

```{r delay-update-delta3, fig.width=10, fig.height=1}
load("fig/6.13a.RData"); print(fig)
load("fig/6.13b.RData"); print(fig)
```

```{r delay-update-lambda-prelims}
sim_dm0                                         %>%
  mutate(y=lambda*30)                           %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(l_label0, 1, co="black")        -> lambda0
sim_dm1                                         %>%
  mutate(y=lambda*30)                           %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(l_label1, 1)                   -> lambda1
r <- range(sim_dm0$lambda, sim_dm1$lambda)*30
lambda0 + expand_limits(y=r) -> fig
save(fig, file="fig/6.14a.RData")
lambda1 + expand_limits(y=r) -> fig
save(fig, file="fig/6.14b.RData")
```

### Figure 6.14. Update of lambda after 150 days of nothing.

```{r delay-update-lambda, fig.width=10, fig.height=1}
load("fig/6.14a.RData"); print(fig)
load("fig/6.14b.RData"); print(fig)
```

### Update 2. We have 240 days of accrual data after 192 days of waiting.

On day 192 (finally!) the trial starts accruing patients. The early phase, as expected, was slow, but now you have `r sum(dat_update2$n)` patients after 239 days of active accrual. So how are we doing now?

```{r delay-fit2-prelims}
y_label <- "Estimated total sample size (update 2)"
f <- "6-beta-test3.jags"

mod_dm2 <- jags.model(f, data=dat_update2, 
  n.adapt = 100)

parms <- c("delta1", "delta2", "delta3", "lambda", "Nstar")
fit_dm2 <- coda.samples(mod_dm2, var=parms, n.iter = 1000)
summary(fit_dm2)
fit_dm2                                         %>%
  as.matrix                                     %>%
  as.data.frame                                 -> sim_dm2
sim_dm2                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label0, 0)                  -> update2
sim_dm1                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label1, 0, co="black")        -> update1
sim_dm0                                         %>%
  rename(y=Nstar)                               %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(N_label2, 0, co="black")        -> prior_estimate
r <- range(sim_dm0$Nstar, sim_dm1$Nstar, sim_dm2$Nstar)
prior_estimate + expand_limits(y=r) -> fig
save(fig, file="fig/6.15a.RData")
update1 + expand_limits(y=r) -> fig
save(fig, file="fig/6.15b.RData")
update2 + expand_limits(y=r) -> fig
save(fig, file="fig/6.15c.RData")
```

### Figure 6.15. Second update of total sample size.

```{r delay-fit2, fig.height=1, fig.width=10}
load("fig/6.15a.RData"); print(fig)
load("fig/6.15b.RData"); print(fig)
load("fig/6.15c.RData"); print(fig)
```

The news is very bad. What's accounting for most of this shortfall?

```{r delay-update2-delta1-prelims}
sim_dm0                                         %>%
  mutate(y=delta1*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d1_label0, 0, co="black")       -> delta10
sim_dm1                                         %>%
  mutate(y=delta1*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d1_label1, 0)                  -> delta11
sim_dm2                                         %>%
  mutate(y=delta1*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d1_label2, 0)                  -> delta12
r <- T*range(sim_dm0$delta1, sim_dm1$delta1, sim_dm2$delta1)
delta10 + expand_limits(y=r) -> fig
save(fig, file="fig/6.16a.RData")
delta11 + expand_limits(y=r) -> fig
save(fig, file="fig/6.16b.RData")
delta12 + expand_limits(y=r) -> fig
save(fig, file="fig/6.16c.RData")
```

### Figure 6.16. Second update of delta1.

```{r delay-update2-delta1, fig.width=10, fig.height=1}
load("fig/6.16a.RData"); print(fig)
load("fig/6.16b.RData"); print(fig)
load("fig/6.16c.RData"); print(fig)
```

```{r delay-update2-delta2-prelims}
sim_dm0                                         %>%
  mutate(y=delta2*30*N/T)                       %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d2_label0, 1, co="black")       -> delta20
sim_dm1                                         %>%
  mutate(y=delta2*30*N/T)                       %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d2_label1, 1, co="black")       -> delta21
sim_dm2                                         %>%
  mutate(y=delta2*30*N/T)                       %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d2_label2, 1)                  -> delta22
r <- range(sim_dm0$delta2, sim_dm1$delta2, sim_dm2$delta2)*30*N/T
delta20 + expand_limits(y=r) -> fig
save(fig, file="fig/6.17a.RData")
delta21 + expand_limits(y=r) -> fig
save(fig, file="fig/6.17b.RData")
delta22 + expand_limits(y=r) -> fig
save(fig, file="fig/6.17c.RData")
```

### Figure 6.17. Second update of delta2.

```{r delay-update2-delta2, fig.width=10, fig.height=1}
load("fig/6.17a.RData"); print(fig)
load("fig/6.17b.RData"); print(fig)
load("fig/6.17c.RData"); print(fig)
```

```{r delay-update2-delta3-prelims}
sim_dm0                                         %>%
  mutate(y=delta3*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d3_label0, 0, co="black")       -> delta30
sim_dm1                                         %>%
  mutate(y=delta3*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d3_label1, 0, co="black")       -> delta31
sim_dm2                                         %>%
  mutate(y=delta3*T)                            %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(d3_label2, 0)                  -> delta32
r <- T*range(sim_dm0$delta3, sim_dm1$delta3, sim_dm2$delta3)
delta30 + expand_limits(y=r) -> fig
save(fig, file="fig/6.18a.RData")
delta31 + expand_limits(y=r) -> fig
save(fig, file="fig/6.18b.RData")
delta32 + expand_limits(y=r) -> fig
save(fig, file="fig/6.18c.RData")
```

### Figure 6.18. Second update of delta3.

```{r delay-update2-delta3, fig.width=10, fig.height=1}
load("fig/6.18a.RData"); print(fig)
load("fig/6.18b.RData"); print(fig)
load("fig/6.18c.RData"); print(fig)
```

```{r delay-update2-lambda-prelims}
sim_dm0                                         %>%
  mutate(y=lambda*30)                           %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(l_label0, 1, co="black")        -> lambda0
sim_dm1                                         %>%
  mutate(y=lambda*30)                           %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(l_label1, 1, co="black")        -> lambda1
sim_dm2                                         %>%
  mutate(y=lambda*30)                           %>%
  mutate(x=" ")                                 %>%
  custom_boxplot(l_label2, 1)                   -> lambda2
r <- range(sim_dm0$lambda, sim_dm1$lambda, sim_dm1$lambda)*30
lambda0 + expand_limits(y=r) -> fig
save(fig, file="fig/6.19a.RData")
lambda1 + expand_limits(y=r) -> fig
save(fig, file="fig/6.19b.RData")
lambda2 + expand_limits(y=r) -> fig
save(fig, file="fig/6.19c.RData")
```

### Figure 6.19. Second update of lambda.

```{r delay-update2-lambda, fig.width=10, fig.height=1}
load("fig/6.19a.RData"); print(fig)
load("fig/6.19b.RData"); print(fig)
load("fig/6.19c.RData"); print(fig)
```

```{r save_everything, echo=FALSE}
save.image("6-beta-extension.RData")
```
