---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries, echo=FALSE, message=FALSE}
source("0-preliminaries.R", echo=FALSE)
N <- 350
T <- 1095
S <- 0.5
n <- 41
t <- 239
dat_prior   <- list(N=N, T=T, S=S,   n=0, t=0)
dat_update  <- list(N=N, T=T, S=S,   n=n, t=t)
dat_flat    <- list(N=N, T=T, S=1/N, n=n, t=t)
dat_update2 <- list(N=N, T=T, S=S,   n=n, t=129)
dat_flat2   <- list(N=N, T=T, S=1/N, n=n, t=129)

N_label0 <- "Estimated total sample size (prior)"
N_label0a <- sub("prior", "hedged prior", N_label0)
N_label0b <- sub("prior", "simple prior", N_label0)
N_label1a <- sub("prior", "update", N_label0a)
N_label1b <- sub("prior", "update", N_label0b)
N_label1c <- sub("hedged update", "simple linear projection", N_label1a)
N_label1d <- sub("prior", "linear projection", N_label0)
N_label2a <- N_label1a
N_label2b <- N_label1b
N_label2c <- N_label1c
N_label2d <- N_label1d
```

## Part 5. Hedging priors

One problem with informative prior distributions is that many researchers get them wrong. They are either too optimistic about the accrual rate, or they think they know the accrual rate with more certainty than they actually do, or sometimes both.

You can minimize the problems associated with a bad informative prior by adding a hedging hyperparameter.

### Here's the code for a heding hpyerparameter.

```{r hedging-code}
f <- "5-hedging-extension.stan"
# Here's what's hiding in the file 
cat(readLines(f), sep="\n")
```

```{r calculate-hedged-prior}
f <- "5-hedging-extension.stan"
# the control argument prevents a "Divergent transitions after warmup" error.
# See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
fit_hp0 <- stan(file=f,
  data=dat_prior, iter= 1000, chains = 4, 
  control = list(adapt_delta = 0.99))
fit_hp0                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_hp0
```

```{r calculate-simple-prior}
f <- "3-gamma-poisson.stan"
fit_gp0 <- stan(file=f,
  data=dat_prior, iter= 1000, chains = 4)
fit_gp0                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_gp0
```

```{r calculate-hedged-update}
f <- "5-hedging-extension.stan"
fit_hp1 <- stan(file=f,
  data=dat_update, iter= 1000, chains = 4,
  control = list(adapt_delta = 0.99))
fit_hp1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_hp1
```

```{r calculate-simple-update}
f <- "3-gamma-poisson.stan"
fit_gp1 <- stan(file=f,
  data=dat_update, iter= 1000, chains = 4)
fit_gp1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_gp1
```

```{r calculate-flat-update}
f <- "3-gamma-poisson.stan"
fit_fl1 <- stan(file=f,
  data=dat_flat, iter= 1000, chains = 4)
fit_fl1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_fl1
```

```{r calculate-linear-projection}
dat_update                                      %>%
  data.frame                                    %>%
  mutate(Nstar=(n/t)*T)                         %>%
  mutate(x=" ")                                 -> sim_lp1
```

```{r calculate-hedged-update2}
f <- "5-hedging-extension.stan"
fit_hp2 <- stan(file=f,
  data=dat_update2, iter= 1000, chains = 4, 
  control = list(adapt_delta = 0.99))
fit_hp2                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_hp2
```

```{r calculate-simple-update2}
f <- "3-gamma-poisson.stan"
fit_gp2 <- stan(file=f,
  data=dat_update2, iter= 1000, chains = 4)
fit_gp2                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_gp2
```

```{r calculate-flat-update2}
f <- "3-gamma-poisson.stan"
fit_fl2 <- stan(file=f,
  data=dat_flat2, iter= 1000, chains = 4)
fit_fl2                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_fl2
```

```{r calculate-updated-linear-projection}
dat_update2                                     %>%
  data.frame                                    %>%
  mutate(Nstar=(n/t)*T)                         %>%
  mutate(x=" ")                                 -> sim_lp2
```

```{r calculate-common-range}
sim_hp0                                         %>%
  bind_rows(sim_gp0)                            %>%
  bind_rows(sim_hp1)                            %>%
  bind_rows(sim_gp1)                            %>%
  bind_rows(sim_fl1)                            %>%
  bind_rows(sim_lp1)                            %>%
  use_series(Nstar)                             %>%
  range                                         -> y_range
sim_hp0                                         %>%
  bind_rows(sim_gp0)                            %>%
  bind_rows(sim_hp2)                            %>%
  bind_rows(sim_gp2)                            %>%
  bind_rows(sim_fl2)                            %>%
  bind_rows(sim_lp2)                            %>%
  use_series(Nstar)                             %>%
  range                                         -> y_range2
```

```{r save-halfway}
# It was a lot of work to get here, so let's save everything
# to protect against a later crash.
save.image("5-hedging-extension.RData")
```

### Figure 5.1. Comparison of simple and hedged predictions prior to data collection.

```{r plot-priors, fig.width=10, fig.height=1}
pct4 <- c(1, 25, 75, 99)
sim_hp0                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label0a, 0, yp=pct4)   -> hedged_prior_plot

sim_gp0                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label0b, 0, yp=pct4)   -> simple_prior_plot

hedged_prior_plot + expand_limits(y=y_range)
simple_prior_plot + expand_limits(y=y_range)
```

The hedging hyperprior creates a mixture of gamma priors from weak to strong. So it is going to produce more variable predictions than a simple gamma prior.

### Figure 5.2. Updated prediction with a hedged prior.

```{r plot-hedged-update1, fig.width=10, fig.height=1}
sim_hp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1a, 0, yp=pct4)   -> hedged_update1_plot

sim_lp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0)            -> linear_update1_plot

hedged_prior_plot   + expand_limits(y=y_range)
hedged_update1_plot + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

The update with the hedging hyperprior ends up downweighting the strength of the prior distribution, so the weighted average of the data and the prior is weighted very heavily towards the data.

### Figure 5.3. Updated prediction with a simple prior.

```{r plot-simple-update1, fig.width=10, fig.height=1}
sim_gp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1b, 0, yp=pct4)   -> simple_update1_plot

simple_prior_plot   + expand_limits(y=y_range)
simple_update1_plot + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

In contrast, because the simple prior was very strong, the weighted average of the prior and the data is pulled back towards the prior.

### Figure 5.4. Updated prediction with a flat prior.

```{r plot-flat-update1, fig.width=10, fig.height=1}
sim_fl1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0, yp=pct4)   -> flat_update1_plot

flat_update1_plot   + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

The flat prior behaves as you would suspect, putting pretty much all of the weight on the data.

### Figure 5.5. Updated distribution of hedging hyperparameter.

```{r hyperparameter-plot1, fig.width=10, fig.height=1}
pct3 <- c(25, 75, 99)
lb <- "Updated hyperparameter"
sim_hp1                                   %>%
  rename(y=pi)                            %>%
  custom_boxplus(lb, 2, yp=pct3)           +
  expand_limits(y=c(0, 2))
```

The distribution of the hyperparameter shows that when the data and the prior distribution disagree, the hyperparameter shrinks towards zero, effectively weakening the prior. 

### Alternative scenario

Consider an alternative scenario, where the prior distribution and the actual accrual data are in close agreement. This might occur if the time to recruit `r dat_update2$n` patients was `r dat_update2$t` days instead of `r dat_update$t` days. This is an observed accrual rate of `r round(30*dat_update2$n/dat_update2$t, 1)` patients per month which is very close to the prior estimate of accrual rate of `r round(30*N/T)` patients per month.

### Figure 5.6. Alternative update with a hedged prior.

```{r plot-hedged-update2, fig.width=10, fig.height=1}
sim_hp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label2a, 0, yp=pct4)   -> hedged_update2_plot

sim_lp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label2d, 0, yp=pct4)   -> linear_update2_plot

hedged_prior_plot   + expand_limits(y=y_range2)
hedged_update2_plot + expand_limits(y=y_range2)
linear_update2_plot + expand_limits(y=y_range2)
```

The heding hyperprior does not need to downweight the strong prior when the data and the prior as in such close agreement.

### Figure 5.7. Alternative update prediction with a simple prior.

```{r plot-simple-update2, fig.width=10, fig.height=1}
sim_gp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label2b, 0, yp=pct4)   -> simple_update2_plot

simple_prior_plot   + expand_limits(y=y_range2)
simple_update2_plot + expand_limits(y=y_range2)
linear_update2_plot + expand_limits(y=y_range2)
```

The predicted sample size of the simple prior is very similar to the hedging hyperprior when you have such good agreement.

### Figure 5.8. Alternative update with a flat prior.

```{r plot-flat-update2, fig.width=10, fig.height=1}
sim_fl2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label2c, 0, yp=pct4)   -> flat_update2_plot

flat_update2_plot   + expand_limits(y=y_range2)
linear_update2_plot + expand_limits(y=y_range2)
```

The flat prior also is close to the observed accrual rate, but because it does not add the precision of the prior to the precision of the data, you see much more variation in the predicted total sample size.

### Figure 5.9. Alternative update of hedging hyperparameter.

```{r hyperparameter-plot2, fig.width=10, fig.height=1}
sim_hp2                                   %>%
  rename(y=pi)                            %>%
  custom_boxplus("Updated hyperparameter", 2) +
  expand_limits(y=c(0, 2))
```

The hyperparameter does shrink as it did in the earlier case, and in fact, it has expanded slightly, with a mean and median both a bit larger than 1. This is a reward for choosing such a good prior distribution, but if you want to, you can insure that the average weight given to the prior distribution never exceeds 1, even if your prior matches the data perfectly.

```{r save-everything}
save.image("5-hedging-extension.RData")
```
