---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries, echo=FALSE, message=FALSE}
source("0-preliminaries.R", echo=FALSE)
N <- 350
T <- 1095
S <- 0.5
n <- 41
t <- 239
dat_prior  <- list(N=N, T=T, S=S,   n=0, t=0)
dat_update <- list(N=N, T=T, S=S,   n=n, t=t)
dat_flat   <- list(N=N, T=T, S=1/N, n=n, t=t)

N_label0 <- "Estimated total sample size (prior)"
N_label0a <- sub("prior", "hedged prior", N_label0)
N_label0b <- sub("prior", "simple prior", N_label0)
N_label1a <- sub("prior", "update", N_label0a)
N_label1b <- sub("prior", "update", N_label0b)
N_label1c <- sub("hedged update", "simple linear projection", N_label1a)
N_label2 <- sub("prior", "linear projection", N_label0)
```

## Hedging priors

One problem with informative prior distributions is that many researchers get them wrong. They are either too optimistic about the accrual rate, or they think they know the accrual rate with more certainty than they actually do, or sometimes both.

You can minimize the problems associated with a bad informative prior by adding a hedging hyperparameter.

### Here's the code for a heding hpyerparameter.

```{r hedging-code}
f <- "5-hedging-extension.stan"
# Here's what's hiding in the file 
cat(readLines(f), sep="\n")
```

```{r calculate-hedged-prior}
f <- "5-hedging-extension.stan"
fit_hp0 <- stan(file=f,
  data=dat_prior, iter= 1000, chains = 4)
fit_hp0                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_hp0
```

```{r calculate-simple-prior}
f <- "3-gamma-poisson.stan"
fit_gp0 <- stan(file=f,
  data=dat_prior, iter= 1000, chains = 4)
fit_gp0                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_gp0
```

```{r calculate-hedged-update}
f <- "5-hedging-extension.stan"
fit_hp1 <- stan(file=f,
  data=dat_update, iter= 1000, chains = 4)
fit_hp1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_hp1
```

```{r calculate-simple-update}
f <- "3-gamma-poisson.stan"
fit_gp1 <- stan(file=f,
  data=dat_update, iter= 1000, chains = 4)
fit_gp1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_gp1
```

```{r calculate-flat-update}
f <- "3-gamma-poisson.stan"
fit_fl1 <- stan(file=f,
  data=dat_flat, iter= 1000, chains = 4)
fit_fl1                                         %>%
  as.data.frame                                 %>%
  mutate(x=" ")                                 -> sim_fl1
```

```{r calculate-linear-projection}
dat_update                                      %>%
  data.frame                                    %>%
  mutate(Nstar=(n/t)*T)                         %>%
  mutate(x=" ")                                 -> sim_lp1
```

```{r calculate-common-range}
sim_hp0                                         %>%
  bind_rows(sim_gp0)                            %>%
  bind_rows(sim_hp1)                            %>%
  bind_rows(sim_gp1)                            %>%
  bind_rows(sim_fl1)                            %>%
  bind_rows(sim_lp1)                            %>%
  use_series(Nstar)                             %>%
  range                                         -> y_range
```

```{r save-halfway}
# It was a lot of work to get here, so let's save everything
# to protect against a later crash.
save.image("5-hedging-extension.RData")
```

### Figure 5.1. Comparison of simple and hedged predictions prior to data collection.

```{r plot-priors, fig.width=7, fig.height=1}
sim_hp0                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label0a, 0)            -> hedged_prior_plot

sim_gp0                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label0b, 0)            -> simple_prior_plot

hedged_prior_plot + expand_limits(y=y_range)
simple_prior_plot + expand_limits(y=y_range)
```

The hedging hyperprior creates a mixture of gamma priors from weak to strong. So it is going to produce more variable predictions than a simple gamma prior.

### Figure 5.2. Updated prediction with a hedged prior.

```{r plot-hedged-update1, fig.width=7, fig.height=1}
sim_hp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1a, 0)            -> hedged_update1_plot

sim_lp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0)            -> linear_update1_plot

hedged_prior_plot   + expand_limits(y=y_range)
hedged_update1_plot + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

### Figure 5.3. Updated prediction with a simple prior.

```{r plot-simple-update1, fig.width=7, fig.height=1}
sim_gp1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1b, 0)            -> simple_update1_plot

simple_prior_plot   + expand_limits(y=y_range)
simple_update1_plot + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

### Figure 5.4. Updated prediction with a flat prior.

```{r plot-flat-update1, fig.width=7, fig.height=1}
sim_fl1                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0)            -> flat_update1_plot

flat_update1_plot   + expand_limits(y=y_range)
linear_update1_plot + expand_limits(y=y_range)
```

### Figure 5.5. Updated distribution of hedging hyperparameter.

```{r hyperparameter-plot1, fig.width=7, fig.height=1}
sim_hp1                                   %>%
  rename(y=pi)                            %>%
  custom_boxplus("Updated hyperparameter", 2) +
  expand_limits(y=0)
```

### Figure 5.6. Alternative update with a hedged prior.

```{r plot-hedged-update2, fig.width=7, fig.height=1}
sim_hp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1a, 0)            -> hedged_update2_plot

sim_lp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0)            -> linear_update2_plot

hedged_prior_plot   + expand_limits(y=y_range)
hedged_update2_plot + expand_limits(y=y_range)
linear_update2_plot + expand_limits(y=y_range)
```

### Figure 5.7. Alternative update prediction with a simple prior.

```{r plot-simple-update2, fig.width=7, fig.height=1}
sim_gp2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1b, 0)            -> simple_update1_plot

simple_prior_plot   + expand_limits(y=y_range)
simple_update2_plot + expand_limits(y=y_range)
linear_update2_plot + expand_limits(y=y_range)
```

### Figure 5.8. Alternative update with a flat prior.

```{r plot-flat-update2, fig.width=7, fig.height=1}
sim_fl2                                   %>%
  rename(y=Nstar)                         %>%
  custom_boxplot(N_label1c, 0)            -> flat_update2_plot

flat_update2_plot   + expand_limits(y=y_range)
linear_update2_plot + expand_limits(y=y_range)
```

### Figure 5.9. Alternative update of hedging hyperparameter.

```{r hyperparameter-plot2, fig.width=7, fig.height=1}
sim_hp2                                   %>%
  rename(y=pi)                            %>%
  custom_boxplus("Updated hyperparameter", 2) +
  expand_limits(y=0)
```



Notice that the large discrepancy with a pure data projection versus the informative prior. When there is a discrepancy, the hedging hyperprior will strongly downweight the informative prior.

The following boxplot shows how much the hedging hyperparameter downweighted the prior distribution

### Figure 5.5. Updated hedging hyperprior.


If you compared this to a flat prior, you would see that the flat prior would line up perfectly with the data projection.

### Figure 5.3. Comparison to flat prior.


A non-Bayesian solution would probably also line up perfectly with the data projection.


Let's look at the behavior of the hedging hyperprior when it's not needed--when the trial is actually slightly ahead of schedule (41 patients in 129 days).


### Figure 5.4. Performance of hedging hyperprior under better circumstances.


### Figure 5.5. Comparison to flat prior under better circumstances.


The following boxplot shows how much the hedging hyperparameter downweighted the prior distribution. In this case, the data actually upweighted the prior slightly on average. Think of it as a reward for choosing your prior distribution so well. 

There's a technical fix that you can make so that the mean of the hyperparameter never exceeds 1, but we won't talk about it here.

### Figure 5.6. Updated hedging hyperprior under better circumstances.

```{r downweight2, fig.height=1, fig.width=7, eval=FALSE}
sim_hd4 %>%
  mutate(i=" ")                          %>%
  ggplot(aes(i, pi))                      +
  expand_limits(y=c(0,2))                 +
  ylab("Hedging hyperparameter")          + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()
```

```{r save-everything}
save.image("5-hedging-extension.RData")
```
