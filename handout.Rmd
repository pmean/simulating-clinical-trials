---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "May 25, 2017"
output: html_document
---

# Simulation before, during, and after a clinical trial: A Bayesian approach

## Abstract

Simulation of a clinical trial gives you answers to important economic, logistical, or scientific questions about the trial when some of the features are difficult to characterize with perfect precision. A Bayesian approach with informative priors offers a flexible framework for trial simulation. It provides a seamless transition from simulation prior to the trial to simulation during the trial itself. Although informative priors are controversial, you can avoid perceptions of bias by restricting the informative priors to clinical trial features that are independent of your research hypothesis. You can protect your interim predictions against unrealistic prior beliefs by implementing the hedging hyperprior, a simple hyperdistribution that downweights the strength of the prior when there is a discrepancy between the prior distribution and data observed during the trial itself. The Bayesian approach also gives you a simple post mortem analysis after the trial ends. You can compute percentile values by plugging the point estimates from the actual clinical trial data into the corresponding prior distributions. Over multiple trials, a deviation in these percentiles from a uniform distribution indicates biased specification of the informative priors. The Bayesian approach to trial simulation will be illustrated using various patient accrual models.

Keywords: hedging hyperprior; informative prior distributions; Markov Chain Monte Carlo; patient accrual.

## Introduction.

"A Bayesian is one who, vaguely expecting a horse, and catching a glimpse of a donkey, strongly believes he has seen a mule." --Stephen Senn

The fundamental approach in Bayesian data analysis is combining information from a prior distribution with information from the data. The posterior mean is a weighted average of the prior mean and the mean of the data. This is only true when you use an informative prior. When you use a non-informative prior (sometimes called a flat prior), the posterior mean is pretty much equal to the mean of the data.

The use of informative priors in testing efficacy and safety is controversial, but this should not stop you from using informative priors in monitoring the operational characteristics of a clinical trial.

## Part 1. An illustration of various simulations

```{r key-data, echo=FALSE}
library(knitr)
library(ggplot2)
opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE)

N <- 350
T <- 1095
S <- 0.4
```

Consider a clinical trial that plans to run for T = `r T` days (`r T/365` years). You hope to recruit N = `r N` patients in that time, which would mean `r round(N/T, 2)` patients per day or `r round(30*N/T, 1)` patients per month. You suspect, however, that the accrual rate might actually be quite a bit higher or quite a bit lower than this target. You set a prior distribution on the accrual rate that is Gamma(`r N*S`, `r T*S`). You need to wait for an explanation of why this might be a reasonable prior distribution. With this prior distribution, you can simulate many things.

## Figure 1.1. Simulation of a clinical trial with a fixed sample size.

```{r simulate-time, fig.width=10, fig.height=5, eval=TRUE}
load("fig/1.1.Rdata")
print(fig)
```

This is simulation of the amount of time it would take to recruit `r N` patients. The target is `r T` days, but some simulations take less time and others take more time.

### Figure 1.2. Simulation of a clinical trial with a fixed time frame.

```{r simulate-n, fig.width=10, fig.height=5}
load("fig/1.2.RData")
print(fig)
```

This is simulation of the number of patients you can recruit if you restrict the amount of time spentt to exactly `r T` days. The target is `r N` patients, but some simulations estimate a larger or a smaller number of patients.

### Figure 1.3. Simulation of a trial with a conditional endpoint.

```{r simulate-composite, fig.width=10, fig.height=5, eval=TRUE}
load("fig/1.3.RData")
print(fig)
```

This is a trial with a conditional endpoint. You will end the trial when you get `r N` patients or your trial takes `r T` days, whichever comes first.

### Figure 1.4. Simulation of the cost of a clinical trial. 

```{r simulate-cost, fig.width=10, fig.height=5, eval=TRUE}
load("fig/1.4.RData")
print(fig)
```

This is the same conditional endpoint, but you are measuring the cost of the trial rather than the number of patients or the amount of time. The cost is 80 British Pounds for each day of the trial and 20 British Pounds for each patient in the trial.

---
title: "Simulating clinical trials, paths in a simulation"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries, message=FALSE, echo=FALSE}
source("0-preliminaries.R", echo=FALSE)
pctl_list <- c(1, 25, 50, 75, 99)
N <- 350
T <- 1095
S <- 0.4
dat_prior <- list(N=N, T=T, S=S)
pts <- unlist(read.csv("2-paths-count.csv"))
dat_updated <- list(N=350, T=3*365, S=0.5, n=pts, t=length(pts))
```

## Part 2.  Paths in a simulation

When you simulate a clinical trial, you won't do this two times. You'll do it several thousand times, because computer cycles are cheap. You can run these simulations before the trial starts, but you can continue to run them during the trial itself. You should even run a simulation after the trial ends, comparing the actual trial results with what you thought they might be prior to the start of the trial. Consider this a sort of "post mortem" analysis.

## Figure 2.1. 1000 simulations run prior to start of a clinical trial.

```{r path1, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.1.RData")
print(fig)
```

I also want to talk about simulating a clinical trial during the trial. What this means is that you have information sample size up to a certain point in time and you want to simulate how rapidly the sample size might increase for the remainder of time in the trial.

## Figure 2.2. 1000 simulations run during a clinical trial.

```{r path2, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.2.RData")
print(fig)
```
## Figure 2.3. Post mortem examination of actual trial results.

```{r path3, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.3.RData")
print(fig)
```

When the trial ends, you can compare the actual accrual results to what you thought you knew before the trial started. In this particular trial, some of the interim values are made up, but it reflects a trial that ended up short of the target sample size (341 instead of 350 patients) in spite of the fact that it needed 1336 days instead of 1095. Your prior distribution was overly optimistic.
