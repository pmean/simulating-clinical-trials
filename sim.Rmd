---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
dat <- NULL
fit <- NULL
sim <- NULL
```

```{r gamma-poisson-before, error=TRUE}
f <- "gamma-poisson-before.stan"
dat_before <- list(N=350, T=3*365, S=0.5)
fit_gp1 <- stan(file=f,
  data=dat_before, iter= 1000, chains = 4)

tidy(fit_gp1)

fit_gp1              %>%
  as.data.frame      %>%
  mutate(i="before") -> sim_gp1

sim_gp1                                  %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  ggtitle("gamma-poisson-before")         +
  geom_boxplot()                          +
  coord_flip()
```

```{r gamma-poisson-during, error=TRUE}
f <- "gamma-poisson-during.stan"
dat_during <- list(N=350, T=3*365, S=0.5, n=41, t=239)
fit_gp2 <- stan(file=f,
  data=dat_during, iter= 1000, chains = 4)

tidy(fit_gp2)

fit_gp2              %>%
  as.data.frame      %>%
  mutate(i="during") %>%
  bind_rows(sim_gp1) -> sim_gp2

sim_gp2                                  %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  ggtitle("gamma-poisson-during")         +
  geom_boxplot()                          +
  coord_flip()
```

```{r gamma-poisson-after, error=TRUE}
data.frame(
  i="after",
  lambda=341/ 1336,
  stringsAsFactors=FALSE) %>%
  bind_rows(sim_gp1)      -> sim_gp3

head(sim_gp3)

sim_gp3                                  %>%
  ggplot(aes(i, lambda*30))               +
  ylab("patients per month")              + 
  xlab(" ")                               +
  geom_boxplot()                          +
  ggtitle("gamma-poisson-after")          +
  coord_flip()
```

```{r pi-extension-before, error=TRUE}
f <- "pi-extension-before.stan"
dat_before <- list(N=350, T=3*365, S=0.5)
fit_pe1 <- stan(file=f,
  data=dat_before, iter= 1000, chains = 4)

tidy(fit_pe1, conf.int=TRUE)

fit_pe1              %>%
  as.data.frame      %>%
  mutate(i="before") -> sim_pe1

sim_pe1                                  %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  ggtitle("hedging prior before")         +
  geom_boxplot()                          +
  coord_flip()
```

```{r pi-extension-during, error=TRUE}
f <- "pi-extension-during.stan"
dat_during <- list(N=350, T=3*365, S=0.5, n=41, t=239)
fit_pe2 <- stan(file=f,
  data=dat_during, iter= 1000, chains = 4)

tidy(fit_pe2, conf.int=TRUE)

fit_pe2              %>%
  as.data.frame      %>%
  mutate(i="during") %>%
  bind_rows(sim_pe1) -> sim_pe2

sim_pe2                                  %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  ggtitle("hedging prior during")         +
  geom_boxplot()                          +
  coord_flip()
```

```{r pi-extension-after, error=TRUE}
data.frame(
  i="after",
  lambda=341/ 1336,
  stringsAsFactors=FALSE) %>%
  bind_rows(sim_pe1)      -> sim_pe3

head(sim_pe3)

sim_pe3                                  %>%
  ggplot(aes(i, lambda*30))               +
  ylab("patients per month")              + 
  xlab(" ")                               +
  ggtitle("hedging prior after")          +
  geom_boxplot()                          +
  coord_flip()
```


```{r alpha-extension-before, error=TRUE}
f <- "alpha-extension-before.stan"
dat_before <- list(N=350, T=3*365, S=0.5)
fit_ae1 <- stan(file=f,
  data=dat_before, iter= 1000, chains = 4)

tidy(fit_ae1, conf.int=TRUE)

fit_ae1              %>%
  as.data.frame      %>%
  mutate(i="before") -> sim_ae1

sim_ae1                                  %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()

sim_ae1                                  %>%
  ggplot(aes(30*lambda, Nstar))           +
  ylab("Final sample size")               + 
  xlab("Accrual rate")                    +
  geom_point()

sim_ae1                                  %>%
  ggplot(aes(alpha, Nstar))               +
  ylab("Final sample size")               + 
  xlab("Time before first accrual")       +
  geom_point()

sim_ae1                                  %>%
  ggplot(aes(omega, Nstar))               +
  ylab("Final sample size")               + 
  xlab("Time until full accrual")         +
  geom_point()

sim_ae1                                  %>%
  ggplot(aes(delta, Nstar))               +
  ylab("Final sample size")               + 
  xlab("Startup accrual penalty")         +
  geom_point()
```