---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r gamma-exponential, error=TRUE}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(rstan)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

dat_before <- list(N=350, T=3*365, S=0.5)
fit_before <- stan(file='gamma-exponential-before.stan',
  data=dat_before, iter= 1000, chains = 4)

tidy(fit_before, conf.int=TRUE)

fit_before           %>%
  as.data.frame      %>%
  mutate(i="before") -> sim_before

sim_before                               %>%
  ggplot(aes(i, Tstar*12))                +
  scale_y_continuous(breaks=3*(0:24),
    minor_breaks=3*(0:24),
    expand=c(0, 0))                       +
  expand_limits(y=0)                      +
  ylab("time in months")                  + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()

dat_during <- list(N=350, T=3*365, S=0.5, n=41, t=239)
fit_during <- stan(file='gamma-exponential-during.stan',
  data=dat_during, iter= 1000, chains = 4)

tidy(fit_during, conf.int=TRUE)

fit_during           %>%
  as.data.frame      %>%
  mutate(i="during") %>%
  bind_rows(sim_before) -> sim_during

sim_during                               %>%
  ggplot(aes(i, Tstar*12))                +
  scale_y_continuous(breaks=3*(0:24),
    minor_breaks=3*(0:24),
    expand=c(0, 0))                       +
  expand_limits(y=0)                      +
  ylab("time in months")                  + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()
  
data.frame(
  i="after",
  beta=341/ 1336,
  lambda=1336 / 341,
  stringsAsFactors=FALSE) %>%
  bind_rows(sim_before)   -> sim_after

sim_after                                %>%
  ggplot(aes(i, beta*30))                 +
  ylab("patients per month")              + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()

```

```{r gamma-poisson, error=TRUE}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

fit_before <- stan(file='gamma-poisson-before.stan',
  data=dat_before, iter= 1000, chains = 4)

tidy(fit_before, conf.int=TRUE)

fit_before           %>%
  as.data.frame      %>%
  mutate(i="before") -> sim_before

sim_before                               %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()



fit_during <- stan(file='gamma-poisson-during.stan',
  data=dat_during, iter= 1000, chains = 4)

tidy(fit_during, conf.int=TRUE)

fit_during           %>%
  as.data.frame      %>%
  mutate(i="during") %>%
  bind_rows(sim_before) -> sim_during

sim_during                               %>%
  ggplot(aes(i, Nstar))                   +
  expand_limits(y=0)                      +
  ylab("Final sample size")               + 
  xlab(" ")                               +
  geom_boxplot()                          +
  coord_flip()
```
