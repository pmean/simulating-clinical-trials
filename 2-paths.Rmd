---
title: "Simulating clinical trials"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries, echo=FALSE, message=FALSE, warning=FALSE}
library(broom)
library(dplyr)
library(ggplot2)
library(knitr)
library(magrittr)
library(rjags)
library(rstan)
library(tidyr)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  fig.width=5,
  fig.height=1)
```

## Paths in a simulation

You won't do this three times. You'll do it several thousand times, because computer cycles are cheap. Here's what a few thousand simulations might look like.

```{r paths-before-trial, echo=FALSE, fig.width=4, fig.height=4}
f <- "paths-before-trial.stan"
dat_before <- list(N=350, T=3*365, S=0.5)
fit_tr1 <- stan(file=f,
  data=dat_before, iter= 1000, warmup=100, chains = 4)

fit_tr1              %>%
  as.data.frame                %>%
  select(starts_with('Nstar')) -> sim_tr1
sim_tr1$j <- 1:dim(sim_tr1)[1]
sim_tr1 %<>% gather(x, y, starts_with('Nstar'))

sim_tr1$x %<>%
  sub("Nstar\\[", "", .) %>%
  sub("\\]", "", .)      %>%
  as.numeric

sim_tr1 %>%
  ggplot(aes(x, y, group=j))                     +
  geom_step(alpha=0.01)                          +
  xlab("Time (days)")                            +
  ylab("Number of patients")                     +
  scale_y_continuous(breaks=50*(0:10))           +
  scale_x_continuous(breaks=365*(0:3))           +
  expand_limits(y=500)
```

I also want to talk about simulating a clinical trial during the trial. What this means is that you have information sample size up to a certain point in time and you want to simulate how rapidly the sample size might increase for the remainder of time in the trial.

```{r path-during-trial, echo=FALSE, fig.width=4, fig.height=4}
pts <- unlist(read.csv("count.csv"))
f <- "paths-during-trial.stan"
dat_during <- list(N=350, T=3*365, S=0.5, n=pts, t=length(pts))
fit_tr2 <- stan(file=f,
  data=dat_during, iter= 1000, warmup=100, chains = 4)

fit_tr2              %>%
  as.data.frame                %>%
  select(starts_with('Nstar')) -> sim_tr2
sim_tr2$j <- 1:dim(sim_tr2)[1]
sim_tr2 %<>% gather(x, y, starts_with('Nstar'))

sim_tr2$x %<>%
  sub("Nstar\\[", "", .) %>%
  sub("\\]", "", .)      %>%
  as.numeric

sim_tr2 %>%
  ggplot(aes(x, y, group=j))                     +
  geom_step(alpha=0.01)                          +
  xlab("Time (days)")                            +
  yab("Number of patients")                     +
  scale_y_continuous(breaks=50*(0:10))           +
  scale_x_continuous(breaks=365*(0:3))           +
  expand_limits(y=500)                           

```

