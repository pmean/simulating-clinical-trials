---
title: "Simulating clinical trials, paths in a simulation"
author: "Steve Simon"
date: "March 22, 2017"
output: html_document
---

```{r preliminaries, message=FALSE, echo=FALSE}
source("0-preliminaries.R", echo=FALSE)
dat_prior <- list(N=N, T=T, S=S)
pts <- unlist(read.csv("2-paths-count.csv"))
dat_updated <- list(N=N, T=T, S=S, n=pts, t=length(pts))
```

### Part 2.  Paths in a simulation

When you simulate a clinical trial, you won't do this two times. You'll do it several thousand times, because computer cycles are cheap. You can run these simulations before the trial starts, but you can continue to run them during the trial itself. You should even run a simulation after the trial ends, comparing the actual trial results with what you thought they might be prior to the start of the trial. Consider this a sort of "post mortem" analysis.

```{r path1-prelims, message=FALSE, warning=FALSE}
# For some reason, Stan is very slow for this simulation. I still want to
# use Stan though because it serves as a good springboard for many of the
# later simulations.
f <- "2-paths-before-trial.stan"
fit_tr1 <- stan(file=f,
  data=dat_prior, iter= 1000, warmup=100, chains = 4)

fit_tr1              %>%
  as.data.frame                %>%
  select(starts_with('Nstar')) -> sim_tr1
sim_tr1$j <- 1:dim(sim_tr1)[1]
sim_tr1 %<>% gather(x, y, starts_with('Nstar'))

sim_tr1$x %<>%
  sub("Nstar\\[", "", .) %>%
  sub("\\]", "", .)      %>%
  as.numeric
sim_tr1                                         %>%
  filter(x==1095)                               %>%
  use_series(y)                                 %>%
  quantile(pctl_list/100)                       -> y_ticks
y_ticks                                         %>%
  round                                         %>%
  paste0(" (", pctl_list, "%)")                 -> y_labels

sim_tr1 %>%
  ggplot(aes(x, y, group=j))                     +
  geom_step(alpha=0.01)                          +
  scale_y_continuous(breaks=y_ticks,
                     labels=y_labels,
                     position="right",
                     minor_breaks=NULL)          +
  scale_x_continuous(breaks=365*(0:3))           +
  xlab("Time (days)")                            +
  ylab("Estimated number of patients (Prior)")   +
  expand_limits(y=500)                          -> fig
save(fig, file="fig/2.1.RData")
```

### Figure 2.1. 1000 simulations run prior to start of a clinical trial.

```{r path1, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.1.RData")
print(fig)
```

I also want to talk about simulating a clinical trial during the trial. What this means is that you have information sample size up to a certain point in time and you want to simulate how rapidly the sample size might increase for the remainder of time in the trial.

```{r path2-prelims}
f <- "2-paths-during-trial.stan"
fit_tr2 <- stan(file=f,
  data=dat_updated, iter= 1000, warmup=100, chains = 4)

fit_tr2              %>%
  as.data.frame                %>%
  select(starts_with('Nstar')) -> sim_tr2
sim_tr2$j <- 1:dim(sim_tr2)[1]
sim_tr2 %<>% gather(x, y, starts_with('Nstar'))

sim_tr2$x %<>%
  sub("Nstar\\[", "", .) %>%
  sub("\\]", "", .)      %>%
  as.numeric

sim_tr2                                         %>%
  filter(x==T)                                  %>%
  use_series(y)                                 %>%
  quantile(pctl_list/100)                       -> y_ticks
y_ticks                                         %>%
  round                                         %>%
  paste0(" (", pctl_list, "%)")                 -> y_labels

sim_tr2 %>%
  ggplot(aes(x, y, group=j))                     +
  geom_step(alpha=0.01)                          +
  xlab("Time (days)")                            +
  ylab("Estimated number of patients (Updated)") +
  scale_y_continuous(breaks=y_ticks,
                     labels=y_labels,
                     position="right",
                     minor_breaks=NULL)          +
  scale_x_continuous(breaks=365*(0:3))           +
  expand_limits(y=500)                          -> fig
save(fig, file="fig/2.2.RData")
```

### Figure 2.2. 1000 simulations run during a clinical trial.

```{r path2, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.2.RData")
print(fig)
```

```{r path3-prelims-1}
# I do not have the exact path to the final result, but I do know that
# this trial ended on day 1336 with 341 patients. So it is easy to make
# a realistic looking path from day 239 with 41 patients.
x1 <- rpois(2000, 350/1095)
x2 <- x1[x1>0]
x3 <- cumsum(x2)
x4 <- min(which(x3>=(341-41)))
x5 <- x2[1:x4]
x5[x4] <- x5[x4] - (x3[x4]-(341-41))
x6 <- c(rep(0, (1336-239-1-length(x5))), x5)
x7 <- sample(x6)
x8 <- cumsum(c(pts,x7))
df <- data.frame(x=1:1336, y=x8, j=0)
```

```{r path3-prelims-2}
load("fig/2.1.RData")
fig                                              +
  expand_limits(x=1336)                          +
  geom_line(data=df, aes(x, y, group=j), col=color2) +
  geom_label(aes(x=1336, y=341, label="(1336,341)")) -> fig
save(fig, sim_gp1, file="fig/2.3.RData")
```

### Figure 2.3. Post mortem examination of actual trial results.

```{r path3, fig.width=10, fig.height=5, eval=TRUE}
load("fig/2.3.RData")
print(fig)
```

When the trial ends, you can compare the actual accrual results to what you thought you knew before the trial started. In this particular trial, some of the interim values are made up, but it reflects a trial that ended up short of the target sample size (341 instead of 350 patients) in spite of the fact that it needed 1336 days instead of 1095. Your prior distribution was overly optimistic.

```{r save-everything}
save.image("2-paths.RData")
```
