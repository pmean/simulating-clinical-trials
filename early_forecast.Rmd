---
title: "Why use informative priors?"
author: "Steve Simon"
date: "April 3, 2017"
output: html_document
---

I've been working with some colleagues on accrual models an other than us, there seem to be no others interested in using a fully Bayesian approach to accrual. There are many reasons why you should consider a fully Bayesian approach, but with this program, I want to illustrate just one of these reasons: a fully Bayesian approach to accrual allows you to make reasonable forecasts very early in the trial.

Cosinder a real accrual example described at

http://www.pmean.com/07/CaseStudyOfAccrualPart2.html

and

http://www.pmean.com/07/CaseStudyOfAccrual.html

I will repeat the key details here.

A clinical trial was planned to start on August 28, 2007 and continue until January 31, 2008, for a total of 22 weeks. The researcher thought it would be reasonable to set the median recruitment rate at three patients per week and the worst case scenario would be recruiting only two patients per week. There is a recommended question that you should ask when eliciting a recruitment rate: "On a scale of 1 to 10, how confident are you in this estimate?" The client said "5" with no hesitation or uncertainty in his voice. 

This leads to a gamma(33, 11) prior distribution.

On the first week, one patient (not three) arrived. In weeks 2, 3, and 4, no patients arrived. Thankfully on week 5, three patients arrived. On week 6 one more patient arrived.

So clearly, we are behind schedule. How bad is it?

Let's try my old R function first, which you can find at

```{r old-r-function}
accrual.plot <- function(n,T,P,m,tm,B=1000,nmax=2*n,sample.paths=0) {
# n is the target sample size
# T is the target completion time
# P is the prior certainty (0 <= P <= 1)
# m is the sample observed to date
# tm is the time to date
# B is the number of simulated accrual times
# nmax is the upper limit on the sample size axis of the graph
#
# set P to zero for a non-informative prior
# set m and tm to zero if no data has been accumulated yet.

  k <- n*P+m
  V <- T*P+tm
  theta <- 1/rgamma(B,shape=k,rate=V)
  simulated.duration <- matrix(NA,nrow=nmax-m,ncol=B)

  for (i in 1:B) {
    wait <- rexp(nmax-m,1/theta[i])
    simulated.duration[,i] <- tm+cumsum(wait)
  }

  tlist <- seq(tm,T,length=100)
  accrual.count <- function(x,t) {m+sum(x<=t)}
  simulated.accrual <- matrix(NA,nrow=100,ncol=B)

  for (i in 1:100) {
    time <- tlist[i]
    simulated.accrual[i,] <- apply(simulated.duration,2,
      accrual.count,t=time)
  }

  lcl <- apply(simulated.accrual,1,quantile,probs=0.025)
  mid <- apply(simulated.accrual,1,quantile,probs=0.500)
  ucl <- apply(simulated.accrual,1,quantile,probs=0.975)

  layout(matrix(c(2,2,2,1),nrow=1))
  par(mar=c(4.1,0.1,0.1,0.1))
  accrual.hist <- cut(simulated.accrual[100,],
    seq(0,nmax,length=40))
  barplot(table(accrual.hist),horiz=TRUE,
    axes=FALSE,xlab=" ",ylab=" ",space=0,
    col="white",names.arg=rep(" ",39))

  par(mar=c(4.1,4.1,0.1,0.1))
  plot(c(0,T),c(0,nmax),xlab="Time",
    ylab="Number of patients",type="n")
  polygon(c(tlist,rev(tlist)),c(lcl,rev(ucl)),
    density=-1,col="gray",border=NA)
  lines(tlist,mid,col="white")
  segments(0,0,tm,m)

  while (sample.paths>0) {
    lines(tlist,simulated.accrual[,sample.paths])
    sample.paths <- sample.paths-1
  }

  pctiles <- matrix(NA,nrow=2,ncol=3)
  dimnames(pctiles) <- list(c("Waiting time",
    "Trial accrual"),c("2.5%","50%","97.5%"))
  pctiles[1,] <- 1/qgamma(c(0.975,0.5,0.025),shape=k,rate=V)
  pctiles[2,1] <- lcl[100]
  pctiles[2,2] <- mid[100]
  pctiles[2,3] <- ucl[100]
  list(pct=pctiles,sa=simulated.accrual)
}

# Run three test examples from the original webpage.

d0 <- accrual.plot(n=350,T=3,P=0.5,m= 0,tm= 0,nmax=500)
d1 <- accrual.plot(n=350,T=3,P=0, m=41,tm=239/365,nmax=500)
d2 <- accrual.plot(n=350,T=3,P=0.5,m=41,tm=239/365,nmax=500)
```

That's a relief that my code from 2008 still works.

So what does the prior prediction look like for 66 patients in 22 weeks and a prior strength of 0.5, which corresponds to a gamma(33, 11)?

```{r prior}
x0 <- accrual.plot(n=66, T=22, P=0.5, m=0, tm=0)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x0$pct[2, ], round(x0$pct[2, ]), cex=1.25, adj=0)
```

```{r weeks one through six}
# week=1, total patients=1
x1 <- accrual.plot(n=66, T=22, P=0.5, m=1, tm=1)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x1$pct[2, ], round(x1$pct[2, ]), cex=1.25, adj=0)

# week=2, total patients=1
x2 <- accrual.plot(n=66, T=22, P=0.5, m=1, tm=2)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x2$pct[2, ], round(x2$pct[2, ]), cex=1.25, adj=0)

# week=3, total patients=1
x3 <- accrual.plot(n=66, T=22, P=0.5, m=1, tm=3)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x3$pct[2, ], round(x3$pct[2, ]), cex=1.25, adj=0)

# week=4, total patients=1
x4 <- accrual.plot(n=66, T=22, P=0.5, m=1, tm=4)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x4$pct[2, ], round(x4$pct[2, ]), cex=1.25, adj=0)

# week=5, total patients=4
x5 <- accrual.plot(n=66, T=22, P=0.5, m=4, tm=5)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x5$pct[2, ], round(x5$pct[2, ]), cex=1.25, adj=0)

# week=6, total patients=5
x6 <- accrual.plot(n=66, T=22, P=0.5, m=5, tm=6)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x6$pct[2, ], round(x6$pct[2, ]), cex=1.25, adj=0)
```

```{r no prior}
# week=1, total patients=1
x1 <- accrual.plot(n=66, T=22, P=0, m=1, tm=1)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x1$pct[2, ], round(x1$pct[2, ]), cex=1.25, adj=0)

# week=2, total patients=1
x2 <- accrual.plot(n=66, T=22, P=0, m=1, tm=2)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x2$pct[2, ], round(x2$pct[2, ]), cex=1.25, adj=0)

# week=3, total patients=1
x3 <- accrual.plot(n=66, T=22, P=0, m=1, tm=3)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x3$pct[2, ], round(x3$pct[2, ]), cex=1.25, adj=0)

# week=4, total patients=1
x4 <- accrual.plot(n=66, T=22, P=0, m=1, tm=4)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x4$pct[2, ], round(x4$pct[2, ]), cex=1.25, adj=0)

# week=5, total patients=4
x5 <- accrual.plot(n=66, T=22, P=0, m=4, tm=5)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x5$pct[2, ], round(x5$pct[2, ]), cex=1.25, adj=0)

# week=6, total patients=5
x6 <- accrual.plot(n=66, T=22, P=0, m=5, tm=6)
segments(0,0, 22, 66, col="red", lwd=3)
segments(0,0, 22, 44, col="blue", lwd=3)
text(22, 66, "66", col="red", cex=1.25, adj=0)
text(22, 44, "44", col="blue", cex=1.25, adj=0)
text(22, x6$pct[2, ], round(x6$pct[2, ]), cex=1.25, adj=0)
```